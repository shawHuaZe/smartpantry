# AI 智能录入配置说明

## 概述

本系统使用阿里云通义千问（Qwen）系列模型实现智能录入功能：
- **图片识别**: qwen-vl-plus (视觉理解，包含OCR能力)
- **文本理解**: qwen-plus (大语言模型)
- **语音识别**: 浏览器原生 Web Speech API (前端)
- **图片生成**: wanx-v1 (通义万相，AI图像生成)

## 配置步骤

### 1. 获取阿里云 API Key

1. 访问 [阿里云百炼平台](https://dashscope.console.aliyun.com/)
2. 登录/注册阿里云账号
3. 进入"API-KEY管理"页面
4. 创建新的 API-KEY
5. 复制 API Key

### 2. 配置后端环境变量

编辑 `server/.env` 文件，添加以下配置：

```bash
# 阿里云通义千问 AI 配置
DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
DASHSCOPE_API_KEY=
```

### 3. 重启后端服务

```bash
cd server
npm run dev
```

## 功能说明

### 图片识别流程

```
用户上传图片
  → 转换为 base64
  → 调用 /api/ai/recognize-receipt
  → qwen-vl-plus 模型识别
  → 返回结构化数据（JSON）
  → 显示在界面上
```

**识别内容**：
- 商品名称
- 价格
- 数量
- 分类（自动判断：Food/Medicine/Home/Other）

### 文本输入流程

```
用户输入文本
  → 调用 /api/ai/understand-text
  → qwen-plus 模型理解
  → 返回结构化数据（JSON）
  → 显示在界面上
```

**支持的输入示例**：
- "超市买了苹果、牛奶、面包，花了80元"
- "今天采购了感冒药和维生素"
- "买了一抽纸和洗衣液"

### 语音识别流程

```
用户点击语音按钮
  → 浏览器 Web Speech API 识别
  → 自动填入文本框
  → 用户可编辑后点击识别
  → 调用文本理解 API
```

**注意**：语音识别使用浏览器原生功能，需要：
- Chrome 浏览器
- HTTPS 环境（或 localhost）
- 用户授权麦克风权限

## AI 模型说明

### qwen-vl-plus

- **用途**：视觉理解 + OCR
- **能力**：
  - 识别图片中的文字（OCR）
  - 理解图片内容
  - 结构化提取信息
- **优势**：一次调用完成OCR+理解，减少误差累积

### qwen-plus

- **用途**：文本理解和生成
- **能力**：
  - 理解自然语言描述
  - 提取关键信息
  - 自动分类
- **优势**：中文理解能力强，价格实惠

### wanx-v1

- **用途**：AI图像生成（通义万相）
- **能力**：
  - 根据物品名称生成产品写实图片
  - 生成高质量商品展示图（4K分辨率）
  - 专业产品摄影风格
- **应用场景**：
  - 批量录入时自动生成物品写实图
  - 为缺失图片的物品补充图片
  - 手动触发图片生成（在编辑弹窗中）
- **优势**：生成速度快，性价比高，适合批量生成

## 图片生成功能

### 智能生成逻辑

系统会智能判断是否需要生成图片：

1. **文本识别录入**：自动标记为"待生成图片"，入库时生成写实图
2. **发票/小票拍照识别**：不保存发票图片，自动生成写实商品图
3. **手动生成**：在编辑弹窗中点击"AI生成图片"按钮

### 自动生成

在批量录入时，如果物品没有图片：
1. 点击"确认入库"按钮
2. 系统自动为所有缺失图片的物品生成写实商品图片
3. 生成完成后创建物品记录

**特点**：
- ✅ 拍照识别发票/小票时，不会保存发票图片
- ✅ 自动生成专业的商品写实图
- ✅ 图片生成失败不影响物品创建

### 手动生成

在批量录入页面的物品列表中：
1. 点击物品卡片的编辑按钮
2. 在编辑弹窗中点击"AI生成图片"按钮
3. 等待生成完成（约5-10秒）
4. 图片会自动保存到物品信息中

**提示**：带"待生成图片"标记的物品表示还没有图片，会在入库时自动生成。

## API 成本估算

按照阿里云百炼定价（2024年）：

| 模型 | 输入价格 | 输出价格 | 单次调用成本估算 |
|------|---------|---------|-----------------|
| qwen-vl-plus | ¥0.02/千tokens | ¥0.06/千tokens | ¥0.05-0.15/次 |
| qwen-plus | ¥0.004/千tokens | ¥0.012/千tokens | ¥0.01-0.03/次 |
| wanx-v1 | ¥0.08/张 | - | ¥0.08/张 |

**示例成本**：
- 识别 100 张小票 ≈ ¥5-15
- 文本理解 100 次 ≈ ¥1-3
- 生成 100 张物品图片 ≈ ¥8

## 常见问题

### Q: 识别结果不准确怎么办？

A: 可以：
1. 编辑识别结果（即将推出）
2. 提供更详细的文本描述
3. 上传更清晰的照片

### Q: 为什么有时识别失败？

A: 可能原因：
1. API Key 未配置或已过期
2. 图片过大（base64 超过限制）
3. 网络连接问题
4. API 配额用完

### Q: 语音识别不准确？

A:
- 使用 Chrome 浏览器
- 在安静环境下使用
- 语速适中，发音清晰
- 识别后可以手动编辑

### Q: 如何提高识别准确率？

A:
**拍照识别**：
- 确保光线充足
- 避免反光和模糊
- 完整拍摄小票内容
- 文字清晰可见

**文本输入**：
- 包含商品名称
- 如有价格信息一并提供
- 提供上下文信息（如"超市"、"药店"）

### Q: 图片生成失败怎么办？

A: 可能原因：
1. API Key 未配置或没有开通图片生成服务
2. 物品名称包含敏感词或不合适的内容
3. 网络连接问题
4. API 配额用完

**解决方案**：
- 检查 API Key 是否正确配置
- 确认已开通通义万相（wanx-v1）服务权限
- 图片生成失败不影响物品创建，可以稍后手动添加图片

### Q: 生成的图片不满意怎么办？

A:
- 可以手动点击重新生成
- 或者在物品创建后，在物品详情页手动上传图片
- 编辑物品名称或分类后重新生成，可能得到更好的结果

### Q: 图片生成要多久？

A:
- 通常需要 5-10 秒
- 取决于网络状况和服务器负载
- 请耐心等待，不要重复点击

## 测试 API

配置完成后，可以使用以下方式测试：

```bash
# 测试文本理解
curl -X POST http://localhost:3001/api/ai/understand-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"text": "超市买了苹果和牛奶"}'

# 测试图片生成
curl -X POST http://localhost:3001/api/ai/generate-image \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"name": "苹果", "category": "Food"}'
```

## 技术支持

- 阿里云百炼文档: https://help.aliyun.com/zh/dashscope/
- 通义千问技术社区: https://github.com/QwenLM/Qwen
